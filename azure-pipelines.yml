# Copyright 2020 Simon Dierl <simon.dierl@cs.tu-dortmund.de>
# SPDX-License-Identifier: ISC
#
# Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby
# granted, provided that the above copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
# INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN
# AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
# PERFORMANCE OF THIS SOFTWARE.

trigger:
  - master

stages:
  - stage: Build
    displayName: 'Run Build Script on all Platforms'
    jobs:
      - job: Linux
        variables:
          UbuntuMirror: 'https://mirrors.ocf.berkeley.edu/ubuntu'
          SwigVersion: '4.0.1'
          SwigBuild: '5'
        pool:
          vmImage: ubuntu-latest
        steps:
          - bash: |
              set -euxo pipefail
              ./ubuntu-install-swig4.sh
              ./build.sh
            env:
              UBUNTU_MIRROR: $(UbuntuMirror)
              SWIG_VERSION: $(SwigVersion)
              SWIG_BUILD: $(SwigBuild)
            timeoutInMinutes: 120
          - publish: 'build'

      - job: OSX
        pool:
          vmImage: macOS-latest
        steps:
          - bash: |
              set -euxo pipefail
              brew install automake coreutils gnu-sed
              export PATH="/usr/local/opt/coreutils/libexec/gnubin:/usr/local/opt/gnu-sed/libexec/gnubin:$PATH"
              ./build.sh
            timeoutInMinutes: 120
          - publish: 'build'

      - job: Windows
        pool:
          vmImage: windows-latest
        steps:
          - script: cinst --no-progress msys2 --params "/InstallDir=C:\msys64"
          - script: >
              C:\msys64\usr\bin\bash --login -c
              "set -euxo pipefail &&
              pacman -S --noconfirm
              git
              mingw-w64-x86_64-boost
              mingw-w64-x86_64-cmake
              mingw-w64-x86_64-gcc
              mingw-w64-x86_64-make
              mingw-w64-x86_64-swig &&
              ln -s /mingw64/bin/mingw32-make.exe /mingw64/bin/make.exe &&
              export PATH=""${PATH}:/mingw64/bin:/mingw32/bin"" &&
              cd $(cygpath -u '$(Build.SourcesDirectory)') &&
              ./build.sh"
            timeoutInMinutes: 120
          - publish: 'build'
